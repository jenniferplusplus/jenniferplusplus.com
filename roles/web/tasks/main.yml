- name: install services
  become: true
  apt:
    name:
      - nginx
      - certbot
      - python3-certbot-nginx
    state: latest

- name: copy ghost site config w/ssl
  become: true
  when: use_ssl == true
  ansible.builtin.template:
    dest: /etc/nginx/sites-available/{{inventory_hostname}}.conf
    src: templates/sites-available.ghost.conf
    mode: 0644
  notify: 
    - restart nginx

- name: copy ghost site config WITHOUT ssl
  become: true
  when: use_ssl == false
  ansible.builtin.template:
    dest: /etc/nginx/sites-available/{{inventory_hostname}}.conf
    src: templates/sites-available.ghost.no-ssl.conf
    mode: 0644
  notify: 
    - restart nginx

- name: enable ghost site
  become: true
  ansible.builtin.file:
    src: /etc/nginx/sites-available/{{inventory_hostname}}.conf
    dest: /etc/nginx/sites-enabled/{{site_name}}.conf
    state: link
  register: enable_ghost
  notify: 
    - restart nginx

- name: copy nginx_status site config
  become: true
  ansible.builtin.copy:
    src: files/status.conf
    dest: /etc/nginx/sites-available/nginx_status.conf
  notify: 
    - restart nginx

- name: enable nginx_status site
  become: true
  ansible.builtin.file:
    src: /etc/nginx/sites-available/nginx_status.conf
    dest: /etc/nginx/sites-enabled/nginx_status.conf
    state: link
  notify: 
    - restart nginx
  
- name: enable telegraf nginx plugin
  become: true
  ansible.builtin.template:
    dest: /etc/telegraf/telegraf.d/nginx.telegraf.conf
    src: templates/nginx.telegraf.conf
    owner: telegraf
    mode: 0644
  notify: restart telegraf

- name: register certbot
  become: true
  ansible.builtin.command: 
    argv: 
      - certbot 
      - register 
      - -n 
      - --agree-tos 
      - --email 
      - "{{admin_email}}"
  args:
    creates: /etc/letsencrypt/accounts

- name: 'get certificate'
  become: true
  when: use_ssl == true
  command: 'certbot certonly -n --nginx --keep -d {{ nginx_server_name }}'
  args:
    creates: '/etc/letsencrypt/live/{{ nginx_server_name }}'
  ignore_errors: true
  notify: 
    - restart nginx
